<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time-Varying Gain (TVG) & Threshold Plot</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.2.0/dist/chartjs-plugin-dragdata.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .instruction {
            margin-bottom: 25px;
            color: #555;
            text-align: center;
            max-width: 800px;
        }
        .controls-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            width: 90%;
            max-width: 1200px;
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 150px;
        }
        .control-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #34495e;
            font-size: 0.75em;
        }
        .control-group input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .control-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .control-value {
            margin-top: 5px;
            margin-bottom: 10px;
            font-size: 0.75em;
            color: #555;
            background-color: #f0f4f7;
            padding: 5px 10px;
            border-radius: 6px;
            border: 1px solid #e0e7ed;
        }

        .collapsible-container {
            width: 90%;
            max-width: 1200px;
            background-color: white;
            padding: 10px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .container-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .container-header h2 {
            margin: 0;
            color: #34495e;
            font-size: 1.3em;
        }

        .toggle-button {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #3498db;
            transition: transform 0.3s ease-out;
            padding: 0;
            line-height: 1;
        }

        .toggle-button.expanded {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding-top: 0;
            padding-bottom: 0;
        }

        .collapsible-content.expanded {
            max-height: 1000px;
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .echo-parameters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 15px;
        }
        .echo-parameters-grid .input-group {
            display: flex;
            flex-direction: column;
        }
        .echo-parameters-grid .input-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #34495e;
            font-size: 0.75em;
        }
        .echo-parameters-grid .input-group input[type="number"],
        .echo-parameters-grid .input-group select,
        .echo-parameters-grid .input-group textarea {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.8em;
            background-color: #fff;
        }
        .echo-results {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f0f7;
            border-radius: 8px;
            border: 1px solid #cce0f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            font-size: 1em;
            grid-column: 1 / -1;
        }
        .echo-results div {
            margin-bottom: 5px;
        }
        .echo-results span {
            font-family: 'Courier New', Courier, monospace;
            background-color: #f0f4f7;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #e0e7ed;
        }
        .echo-results .note {
            font-size: 0.85em;
            color: #777;
            margin-top: 5px;
        }

        .threshold-inputs-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 15px;
            grid-column: 1 / -1;
        }

        .threshold-inputs-row .input-group {
            flex: 1 1 calc(8% - 10px);
            min-width: 50px;
            margin-bottom: 0;
            padding: 0px 20px;
        }

        .threshold-inputs-row .input-group input,
        .threshold-inputs-row .input-group select {
            width: 100%;
        }

        @media (max-width: 768px) {
            .threshold-inputs-row .input-group {
                flex: 1 1 calc(25% - 15px);
            }
        }
        @media (max-width: 480px) {
            .threshold-inputs-row .input-group {
                flex: 1 1 100%;
            }
        }

        .threshold-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 5px;
            padding: 5px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fcfcfc;
        }
        .threshold-input-grid input[type="number"] {
            width: 70%;
            text-align: center;
            padding: 5px;
            font-size: 0.9em;
            border-radius: 4px;
        }


        #tvgChartContainer {
            position: relative;
            width: 90%;
            max-width: 1200px;
            height: 500px;
            background-color: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        #tvgChart {
            width: 100% !important;
            height: 100% !important;
        }

        .action-buttons {
            margin-top: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }

        .action-buttons button {
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            background-color: #3498db;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .action-buttons button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .action-buttons button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #resetZoomBtn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 10;
        }

        #resetZoomBtn:hover {
            background-color: #2980b9;
            transform: scale(1.05);
        }

        #resetZoomBtn svg {
            fill: currentColor;
            width: 24px;
            height: 24px;
        }

        @media (max-width: 768px) {
            .collapsible-container, #tvgChartContainer, .point-info-grid, .register-display {
                width: 95%;
                padding: 15px;
            }
            .point-info-grid {
                grid-template-columns: 1fr;
            }
            .register-table th, .register-table td {
                padding: 8px 10px;
                font-size: 0.9em;
            }
            h1 {
                font-size: 1.8em;
            }
            .instruction {
                font-size: 0.9em;
            }
            .control-group {
                min-width: unset;
                width: 100%;
            }
            .echo-parameters-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .registry-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f4f7;
            border-radius: 8px;
            border: 1px solid #e0e7ed;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .registry-summary h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #34495e;
            font-size: 1.2em;
            text-align: center;
        }
        .registry-summary-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            font-size: 0.9em;
        }
        .registry-summary-table th, .registry-summary-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #dcdcdc;
        }
        .registry-summary-table th {
            background-color: #dbe9f5;
            font-weight: bold;
            color: #34495e;
        }
        .registry-summary-table tr:last-child td {
            border-bottom: none;
        }
        .reg-hex, .reg-bin {
            font-family: 'Courier New', Courier, monospace;
            background-color: #e8f0f7;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #cce0f0;
        }
    </style>
</head>
<body>
    <h1>PGA460 Configuration Tool</h1>

    <div class="collapsible-container">
        <div class="container-header" data-target="echoParamsContent">
            <h2>Echo Parameters</h2>
            <button class="toggle-button">▼</button>
        </div>
        <div id="echoParamsContent" class="collapsible-content">
            <div class="echo-parameters-grid">
                <div class="input-group">
                    <label for="noiseLevelInput">Noise Level (ADC)</label>
                    <input type="number" id="noiseLevelInput" value="5" min="0">
                </div>
                <div class="input-group">
                    <label for="transducerFreq">Transducer (Hz)</label>
                    <input type="number" id="transducerFreq" value="58000" min="1">
                </div>
                <div class="input-group">
                    <label for="numPulses">N Pulses</label>
                    <input type="number" id="numPulses" value="2" min="1">
                </div>
                <div class="input-group">
                    <label for="distanceTarget">Dist. to Target (mm)</label>
                    <input type="number" id="distanceTarget" value="250" min="0">
                </div>
                <div class="input-group">
                    <label for="temperatureC">Temperature (°C)</label>
                    <input type="number" id="temperatureC" value="25" step="0.1">
                </div>
                <div class="input-group">
                    <label for="pressurePa">Pressure (Pa)</label>
                    <input type="number" id="pressurePa" value="101325" min="0">
                </div>
                <div class="input-group">
                    <label for="heightM">Height (m)</label>
                    <input type="number" id="heightM" value="58" step="0.1">
                </div>
                <div class="input-group">
                    <label for="relativeHumidity">RH (%)</label>
                    <input type="number" id="relativeHumidity" value="50" min="0" max="100" step="0.1">
                </div>
                <div class="input-group">
                    <label for="decayTime">Decay Time (µs)</label>
                    <input type="number" id="decayTime" value="1000" min="0">
                </div>
                <div class="echo-results">
                    <div>
                        Speed of Sound: <span id="soundSpeedDisplay">0 m/s</span> |
                        Echo Return Time: <span id="echoReturnTimeDisplay">0 µs</span> |
                        Pulse Length: <span id="pulseLengthDisplay">0 µs</span> |
                        Total Time (Echo + Pulse + Decay): <span id="totalTimeDisplay">0 µs</span> |
                        Theoretical REC_LENGTH: <span id="theoreticalRecLengthDisplay">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="collapsible-container">
        <div class="container-header" data-target="transducerGainContent">
            <h2>Transducer & Gain Settings</h2>
            <button class="toggle-button">▼</button>
        </div>
        <div id="transducerGainContent" class="collapsible-content">
            <div class="echo-parameters-grid">
                <div class="threshold-inputs-row">
                    <div class="input-group">
                        <label for="gainAFE">AFE_GAIN_RNG</label>
                        <select id="gainAFE">
                            <option value="0">58 to 90 dB</option>
                            <option value="1">52 to 84 dB</option>
                            <option value="2">46 to 78 dB</option>
                            <option value="3">32 to 64 dB</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="LPM_EN">LPM_EN</label>
                        <select id="LPM_EN">
                            <option value="0">Low power OFF</option>
                            <option value="1">Low power ON</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="DECPL_TEMP_SEL">DECPL_TEMP_SEL</label>
                        <select id="DECPL_TEMP_SEL">
                            <option value="0">Time Decouple</option>
                            <option value="1">Temperature Decouple</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="DECPL_T">DECPL_T</label>
                        <input type="number" id="DECPL_T" value="0" min="0" max="15" step="1">
                    </div>
                    <div class="control-group">
                        <label for="gainInitSlider">GAIN_INIT</label>
                        <input type="range" id="gainInitSlider" min="0" max="63" step="1" value="0">
                        <div class="control-value" id="gainInitValue">0</div>
                    </div>
                    <div class="control-group">
                        <label for="bpfBwSlider">BPF Bandwidth (kHz)</label>
                        <input type="range" id="bpfBwSlider" min="0" max="3" step="1" value="0">
                        <div class="control-value" id="bpfBwValue">2 kHz</div>
                    </div>
                    <div class="input-group">
                        <label for="DIS_CL">DIS_CL</label>
                        <select id="DIS_CL">
                            <option value="0">Enable current limit</option>
                            <option value="1">Disable current limit</option>
                        </select>
                    </div>
                </div>
                <div class="threshold-inputs-row">
                    <div class="control-group">
                        <label for="CURR_LIM1">CURR_LIM1</label>
                        <input type="range" id="CURR_LIM1" min="0" max="63" step="1" value="0">
                        <div class="control-value" id="CURR_LIM1Value">0</div>
                    </div>
                    <div class="control-group">
                        <label for="lpfCoSlider">LPF Cutoff (kHz)</label>
                        <input type="range" id="lpfCoSlider" min="0" max="3" step="1" value="0">
                        <div class="control-value" id="lpfCoValue">1 kHz</div>
                    </div>
                    <div class="control-group">
                        <label for="CURR_LIM2">CURR_LIM2</label>
                        <input type="range" id="CURR_LIM2" min="0" max="63" step="1" value="0">
                        <div class="control-value" id="CURR_LIM2Value">0</div>
                    </div>
                    <div class="control-group">
                        <label for="p1RecSlider">P1 Record Time</label>
                        <input type="range" id="p1RecSlider" min="0" max="15" step="1" value="0">
                        <div class="control-value" id="p1RecValue">0 (0 µs)</div>
                    </div>
                    <div class="control-group">
                        <label for="p2RecSlider">P2 Record Time</label>
                        <input type="range" id="p2RecSlider" min="0" max="15" step="1" value="0">
                        <div class="control-value" id="p2RecValue">0 (0 µs)</div>
                    </div>
                    <div class="input-group">
                        <label for="tvgT0">TVG T0</label>
                        <select id="tvgT0">
                            <option value="0">100 µs</option>
                            <option value="1">200 µs</option>
                            <option value="2">300 µs</option>
                            <option value="3">400 µs</option>
                            <option value="4">600 µs</option>
                            <option value="5">800 µs</option>
                            <option value="6">1000 µs</option>
                            <option value="7">1200 µs</option>
                            <option value="8">1400 µs</option>
                            <option value="9">2000 µs</option>
                            <option value="10">2400 µs</option>
                            <option value="11">3200 µs</option>
                            <option value="12">4000 µs</option>
                            <option value="13">5200 µs</option>
                            <option value="14">6400 µs</option>
                            <option value="15">8000 µs</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="tvgT1">TVG T1</label>
                        <select id="tvgT1">
                            <option value="0">100 µs</option>
                            <option value="1">200 µs</option>
                            <option value="2">300 µs</option>
                            <option value="3">400 µs</option>
                            <option value="4">600 µs</option>
                            <option value="5">800 µs</option>
                            <option value="6">1000 µs</option>
                            <option value="7">1200 µs</option>
                            <option value="8">1400 µs</option>
                            <option value="9">2000 µs</option>
                            <option value="10">2400 µs</option>
                            <option value="11">3200 µs</option>
                            <option value="12">4000 µs</option>
                            <option value="13">5200 µs</option>
                            <option value="14">6400 µs</option>
                            <option value="15">8000 µs</option>
                        </select>
                    </div>
                </div>
                <div class="threshold-inputs-row">
                    <div class="input-group">
                        <label for="tvgT2">TVG T2</label>
                        <select id="tvgT2">
                            <option value="0">100 µs</option>
                            <option value="1">200 µs</option>
                            <option value="2">300 µs</option>
                            <option value="3">400 µs</option>
                            <option value="4">600 µs</option>
                            <option value="5">800 µs</option>
                            <option value="6">1000 µs</option>
                            <option value="7">1200 µs</option>
                            <option value="8">1400 µs</option>
                            <option value="9">2000 µs</option>
                            <option value="10">2400 µs</option>
                            <option value="11">3200 µs</option>
                            <option value="12">4000 µs</option>
                            <option value="13">5200 µs</option>
                            <option value="14">6400 µs</option>
                            <option value="15">8000 µs</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="tvgT3">TVG T3</label>
                        <select id="tvgT3">
                            <option value="0">100 µs</option>
                            <option value="1">200 µs</option>
                            <option value="2">300 µs</option>
                            <option value="3">400 µs</option>
                            <option value="4">600 µs</option>
                            <option value="5">800 µs</option>
                            <option value="6">1000 µs</option>
                            <option value="7">1200 µs</option>
                            <option value="8">1400 µs</option>
                            <option value="9">2000 µs</option>
                            <option value="10">2400 µs</option>
                            <option value="11">3200 µs</option>
                            <option value="12">4000 µs</option>
                            <option value="13">5200 µs</option>
                            <option value="14">6400 µs</option>
                            <option value="15">8000 µs</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="tvgT4">TVG T4</label>
                        <select id="tvgT4">
                            <option value="0">100 µs</option>
                            <option value="1">200 µs</option>
                            <option value="2">300 µs</option>
                            <option value="3">400 µs</option>
                            <option value="4">600 µs</option>
                            <option value="5">800 µs</option>
                            <option value="6">1000 µs</option>
                            <option value="7">1200 µs</option>
                            <option value="8">1400 µs</option>
                            <option value="9">2000 µs</option>
                            <option value="10">2400 µs</option>
                            <option value="11">3200 µs</option>
                            <option value="12">4000 µs</option>
                            <option value="13">5200 µs</option>
                            <option value="14">6400 µs</option>
                            <option value="15">8000 µs</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="tvgT5">TVG T5</label>
                        <select id="tvgT5">
                            <option value="0">100 µs</option>
                            <option value="1">200 µs</option>
                            <option value="2">300 µs</option>
                            <option value="3">400 µs</option>
                            <option value="4">600 µs</option>
                            <option value="5">800 µs</option>
                            <option value="6">1000 µs</option>
                            <option value="7">1200 µs</option>
                            <option value="8">1400 µs</option>
                            <option value="9">2000 µs</option>
                            <option value="10">2400 µs</option>
                            <option value="11">3200 µs</option>
                            <option value="12">4000 µs</option>
                            <option value="13">5200 µs</option>
                            <option value="14">6400 µs</option>
                            <option value="15">8000 µs</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="tvgG1">TVG G1</label>
                        <input type="number" id="tvgG1" value="0" min="0" max="63" step="1">
                    </div>
                    <div class="input-group">
                        <label for="tvgG2">TVG G2</label>
                        <input type="number" id="tvgG2" value="0" min="0" max="63" step="1">
                    </div>
                    <div class="input-group">
                        <label for="tvgG3">TVG G3</label>
                        <input type="number" id="tvgG3" value="0" min="0" max="63" step="1">
                    </div>
                </div>
                <div class="threshold-inputs-row">
                    <div class="input-group">
                        <label for="tvgG4">TVG G4</label>
                        <input type="number" id="tvgG4" value="0" min="0" max="63" step="1">
                    </div>
                    <div class="input-group">
                        <label for="tvgG5">TVG G5</label>
                        <input type="number" id="tvgG5" value="0" min="0" max="63" step="1">
                    </div>
                    <div class="input-group">
                        <label for="freq_shift">FREQ SHIFT</label>
                        <select id="freq_shift">
                            <option value="0">Disabled</option>
                            <option value="1">Enabled</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="frequencySlider">Frequency</label>
                        <input type="range" id="frequencySlider" min="0" max="250" step="1" value="0">
                        <div class="control-value" id="frequencyValue">0 (30 kHz)</div>
                    </div>
                    <div class="control-group">
                        <label for="deglitchPeriodSlider">Deglitch period</label>
                        <input type="range" id="deglitchPeriodSlider" min="0" max="15" step="1" value="0">
                        <div class="control-value" id="deglitchPeriodValue">0 (0 µs)</div>
                    </div>
                    <div class="control-group">
                        <label for="pulseDeadTimeSlider">Pulse dead Time</label>
                        <input type="range" id="pulseDeadTimeSlider" min="0" max="15" step="1" value="0">
                        <div class="control-value" id="pulseDeadTimeValue">0 (0 µs)</div>
                    </div>
                    <div class="input-group">
                        <label for="interface">Interface</label>
                        <select id="interface">
                            <option value="0">Time-Based</option>
                            <option value="1">UART/OneWire</option>
                        </select>
                    </div>
                </div>
                <div class="threshold-inputs-row">
                    <div class="input-group">
                        <label for="diagnostic">Diagnostic</label>
                        <select id="diagnostic">
                            <option value="0">UART</option>
                            <option value="1">System</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="transceiver">Transceiver</label>
                        <select id="transceiver">
                            <option value="0">Enabled</option>
                            <option value="1">Disabled</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="p1nSlider">P1 PULSE</label>
                        <input type="range" id="p1nSlider" min="0" max="15" step="1" value="0">
                    </div>
                    <div class="control-group">
                        <label for="uartAddrSlider">UART Addr</label>
                        <input type="range" id="uartAddrSlider" min="0" max="7" step="1" value="0">
                        <div class="control-value" id="uartAddrValue">0</div>
                    </div>
                    <div class="control-group">
                        <label for="p2nSlider">P2 PULSE</label>
                        <input type="range" id="p2nSlider" min="0" max="15" step="1" value="0">
                    </div>
                    <div class="input-group">
                        <label for="currentLim">Current Limit</label>
                        <select id="currentLim">
                            <option value="0">Enabled</option>
                            <option value="1">Disabled</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="currentP1Slider">P1 Current</label>
                        <input type="range" id="currentP1Slider" min="0" max="63" step="1" value="0">
                        <div class="control-value" id="currentP1Value">0 (50mA)</div>
                    </div>
                </div>
                <div class="threshold-inputs-row">
                    <div class="control-group">
                        <label for="lpfSlider">LowPass CutOff</label>
                        <input type="range" id="lpfSlider" min="0" max="3" step="1" value="0">
                        <div class="control-value" id="lpfValue">0 (1kHz)</div>
                    </div>
                    <div class="control-group">
                        <label for="currentP2Slider">P2 Current</label>
                        <input type="range" id="currentP2Slider" min="0" max="63" step="1" value="0">
                        <div class="control-value" id="currentP2Value">0 (50mA)</div>
                    </div>
                    <div class="control-group">
                        <label for="p1LenSlider">P1 Rec Len</label>
                        <input type="range" id="p1LenSlider" min="0" max="15" step="1" value="0">
                        <div class="control-value" id="p1LenValue">0 (4096 µs)</div>
                    </div>
                    <div class="control-group">
                        <label for="p2LenSlider">P2 Rec Len</label>
                        <input type="range" id="p2LenSlider" min="0" max="15" step="1" value="0">
                        <div class="control-value" id="p2LenValue">0 (4096 µs)</div>
                    </div>
                    <div class="control-group">
                        <label for="fDiagWinSlider">f Diag Window</label>
                        <input type="range" id="fDiagWinSlider" min="0" max="15" step="1" value="0">
                        <div class="control-value" id="fDiagWinValue">0 (0 T)</div>
                    </div>
                    <div class="control-group">
                        <label for="fDiagLenSlider">f Diag Len</label>
                        <input type="range" id="fDiagLenSlider" min="0" max="15" step="1" value="0">
                        <div class="control-value" id="fDiagLenValue">0 (0 µs)</div>
                    </div>
                </div>
            </div>
            <div class="registry-summary" id="transducer-summary">
            </div>
        </div>
    </div>

    <div class="collapsible-container">
        <div class="container-header" data-target="thresholdP1Content">
            <h2>Threshold & Digital Gain Settings (Preset 1)</h2>
            <button class="toggle-button">▼</button>
        </div>
        <div id="thresholdP1Content" class="collapsible-content">
            <div class="echo-parameters-grid">
                <div class="threshold-inputs-row">
                    <div class="input-group">
                        <label for="thP1Off">TH_P1_OFF</label>
                        <input type="number" id="thP1Off" value="-8" min="-8" max="7" step="1">
                    </div>
                    <div class="input-group">
                        <label for="p1DigGainLrSt">P1_DIG_GAIN_LR_ST</label>
                        <select id="p1DigGainLrSt">
                            <option value="0">TH9</option>
                            <option value="1">TH10</option>
                            <option value="2">TH11</option>
                            <option value="3">TH12</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="p1DigGainLr">P1_DIG_GAIN_LR</label>
                        <select id="p1DigGainLr">
                            <option value="0">x1</option>
                            <option value="1">x2</option>
                            <option value="2">x4</option>
                            <option value="3">x8</option>
                            <option value="4">x16</option>
                            <option value="5">x32</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="p1DigGainSr">P1_DIG_GAIN_SR</label>
                        <select id="p1DigGainSr">
                            <option value="0">x1</option>
                            <option value="1">x2</option>
                            <option value="2">x4</option>
                            <option value="3">x8</option>
                            <option value="4">x16</option>
                            <option value="5">x32</option>
                        </select>
                    </div>
                </div>
                <div class="threshold-inputs-row">
                    <div class="input-group">
                        <label for="thrPr1P1Time">THR P1 T1</label>
                        <select id="thrPr1P1Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P1Level">THR P1 L1</label>
                        <input type="number" id="thrPr1P1Level" value="200" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P2Time">THR P1 T2 (Delta)</label>
                        <select id="thrPr1P2Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P2Level">THR P1 L2</label>
                        <input type="number" id="thrPr1P2Level" value="180" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P3Time">THR P1 T3 (Delta)</label>
                        <select id="thrPr1P3Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P3Level">THR P1 L3</label>
                        <input type="number" id="thrPr1P3Level" value="150" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P4Time">THR P1 T4 (Delta)</label>
                        <select id="thrPr1P4Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P4Level">THR P1 L4</label>
                        <input type="number" id="thrPr1P4Level" value="120" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P5Time">THR P1 T5 (Delta)</label>
                        <select id="thrPr1P5Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P5Level">THR P1 L5</label>
                        <input type="number" id="thrPr1P5Level" value="90" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P6Time">THR P1 T6 (Delta)</label>
                        <select id="thrPr1P6Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P6Level">THR P1 L6</label>
                        <input type="number" id="thrPr1P6Level" value="70" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P7Time">THR P1 T7 (Delta)</label>
                        <select id="thrPr1P7Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P7Level">THR P1 L7</label>
                        <input type="number" id="thrPr1P7Level" value="50" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P8Time">THR P1 T8 (Delta)</label>
                        <select id="thrPr1P8Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P8Level">THR P1 L8</label>
                        <input type="number" id="thrPr1P8Level" value="30" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P9Time">THR P1 T9 (Delta)</label>
                        <select id="thrPr1P9Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P9Level">THR P1 L9</label>
                        <input type="number" id="thrPr1P9Level" value="20" min="0" max="255" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P10Time">THR P1 T10 (Delta)</label>
                        <select id="thrPr1P10Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P10Level">THR P1 L10</label>
                        <input type="number" id="thrPr1P10Level" value="15" min="0" max="255" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P11Time">THR P1 T11 (Delta)</label>
                        <select id="thrPr1P11Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P11Level">THR P1 L11</label>
                        <input type="number" id="thrPr1P11Level" value="10" min="0" max="255" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P12Time">THR P1 T12 (Delta)</label>
                        <select id="thrPr1P12Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr1P12Level">THR P1 L12</label>
                        <input type="number" id="thrPr1P12Level" value="5" min="0" max="255" step="1">
                    </div>
                </div>
            </div>
            <div class="registry-summary" id="thresholdP1-summary">
            </div>
        </div>
    </div>

    <div class="collapsible-container">
        <div class="container-header" data-target="thresholdP2Content">
            <h2>Threshold & Digital Gain Settings (Preset 2)</h2>
            <button class="toggle-button">▼</button>
        </div>
        <div id="thresholdP2Content" class="collapsible-content">
            <div class="echo-parameters-grid">
                <div class="threshold-inputs-row">
                    <div class="input-group">
                        <label for="thP2Off">TH_P2_OFF</label>
                        <input type="number" id="thP2Off" value="7" min="-8" max="7" step="1">
                    </div>
                    <div class="input-group">
                        <label for="p2DigGainLrSt">P2_DIG_GAIN_LR_ST</label>
                        <select id="p2DigGainLrSt">
                            <option value="0">TH9</option>
                            <option value="1">TH10</option>
                            <option value="2">TH11</option>
                            <option value="3">TH12</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="p2DigGainLr">P2_DIG_GAIN_LR</label>
                        <select id="p2DigGainLr">
                            <option value="0">x1</option>
                            <option value="1">x2</option>
                            <option value="2">x4</option>
                            <option value="3">x8</option>
                            <option value="4">x16</option>
                            <option value="5">x32</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="p2DigGainSr">P2_DIG_GAIN_SR</label>
                        <select id="p2DigGainSr">
                            <option value="0">x1</option>
                            <option value="1">x2</option>
                            <option value="2">x4</option>
                            <option value="3">x8</option>
                            <option value="4">x16</option>
                            <option value="5">x32</option>
                        </select>
                    </div>
                </div>
                <div class="threshold-inputs-row">
                    <div class="input-group">
                        <label for="thrPr2P1Time">THR P2 T1</label>
                        <select id="thrPr2P1Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P1Level">THR P2 L1</label>
                        <input type="number" id="thrPr2P1Level" value="200" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P2Time">THR P2 T2 (Delta)</label>
                        <select id="thrPr2P2Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P2Level">THR P2 L2</label>
                        <input type="number" id="thrPr2P2Level" value="180" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P3Time">THR P2 T3 (Delta)</label>
                        <select id="thrPr2P3Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P3Level">THR P2 L3</label>
                        <input type="number" id="thrPr2P3Level" value="150" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P4Time">THR P2 T4 (Delta)</label>
                        <select id="thrPr2P4Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P4Level">THR P2 L4</label>
                        <input type="number" id="thrPr2P4Level" value="120" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P5Time">THR P2 T5 (Delta)</label>
                        <select id="thrPr2P5Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P5Level">THR P2 L5</label>
                        <input type="number" id="thrPr2P5Level" value="90" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P6Time">THR P2 T6 (Delta)</label>
                        <select id="thrPr2P6Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P6Level">THR P2 L6</label>
                        <input type="number" id="thrPr2P6Level" value="70" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P7Time">THR P2 T7 (Delta)</label>
                        <select id="thrPr2P7Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P7Level">THR P2 L7</label>
                        <input type="number" id="thrPr2P7Level" value="50" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P8Time">THR P2 T8 (Delta)</label>
                        <select id="thrPr2P8Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P8Level">THR P2 L8</label>
                        <input type="number" id="thrPr2P8Level" value="30" min="0" max="248" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P9Time">THR P2 T9 (Delta)</label>
                        <select id="thrPr2P9Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P9Level">THR P2 L9</label>
                        <input type="number" id="thrPr2P9Level" value="20" min="0" max="255" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P10Time">THR P2 T10 (Delta)</label>
                        <select id="thrPr2P10Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P10Level">THR P2 L10</label>
                        <input type="number" id="thrPr2P10Level" value="15" min="0" max="255" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P11Time">THR P2 T11 (Delta)</label>
                        <select id="thrPr2P11Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P11Level">THR P2 L11</label>
                        <input type="number" id="thrPr2P11Level" value="10" min="0" max="255" step="1">
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P12Time">THR P2 T12 (Delta)</label>
                        <select id="thrPr2P12Time">
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="thrPr2P12Level">THR P2 L12</label>
                        <input type="number" id="thrPr2P12Level" value="5" min="0" max="255" step="1">
                    </div>
                </div>
            </div>
            <div class="registry-summary" id="thresholdP2-summary">
            </div>
        </div>
    </div>
    
    <div id="tvgChartContainer">
        <canvas id="tvgChart"></canvas>
        <button id="resetZoomBtn" title="Reset Zoom">
            <svg viewBox="0 0 48 48">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C8.01 14 6 11.99 6 9.5S8.01 5 10.5 5 15 7.01 15 9.5 12.99 14 10.5 14z"/>
            </svg>
        </button>
    </div>
    
    <div class="action-buttons">
        <button id="saveSettingsBtn">Save Settings (.h)</button>
        <button id="loadSettingsBtn">Load Settings (.h)</button>
        <button id="setMinValuesBtn">Set All to Minimum</button>
        <input type="file" id="loadFileInput" accept=".h" style="display: none;">
    </div>

    <script>
        const R_D = 287.05; 
        const R_V = 461.495;
        const GAMMA = 1.4;
        const L = 0.0065;
        const T0_KELVIN = 288.15;
        const P0_PA = 101325.0;
        const G = 9.80665;
        const M = 0.0289644;
        const R_UNIVERSAL = 8.3144598;
        const KELVIN_OFFSET = 273.15;
        const RH_DIVISOR = 100.0;
        const WATER_VAPOR_EFFECT = 0.6077;
        const SATURATION_CONSTANT = 6.1078;

        const tvgTimeMap = {
            0: 100, 1: 200, 2: 300, 3: 400, 4: 600, 5: 800, 6: 1000, 7: 1200,
            8: 1400, 9: 2000, 10: 2400, 11: 3200, 12: 4000, 13: 5200, 14: 6400, 15: 8000
        };
        const tvgTimeInverseMap = {
            100: 0, 200: 1, 300: 2, 400: 3, 600: 4, 800: 5, 1000: 6, 1200: 7,
            1400: 8, 2000: 9, 2400: 10, 3200: 11, 4000: 12, 5200: 13, 6400: 14, 8000: 15
        };
        const thrPxTimeMap = {
            0: 100, 1: 200, 2: 300, 3: 400, 4: 600, 5: 800, 6: 1000, 7: 1200,
            8: 1400, 9: 2000, 10: 2400, 11: 3200, 12: 4000, 13: 5200, 14: 6400, 15: 8000
        };
        const thrPxTimeInverseMap = {
            100: 0, 200: 1, 300: 2, 400: 3, 600: 4, 800: 5, 1000: 6, 1200: 7,
            1400: 8, 2000: 9, 2400: 10, 3200: 11, 4000: 12, 5200: 13, 6400: 14, 8000: 15
        };

        let currentRegisterValues = {};
        let tvgChart;
        const MAX_TIME_US = 8000;
        const MIN_THRESHOLD_TIME_US = 100;

        let tvgPointsAbsolute = [];
        let thresholdP1PointsAbsolute = [];
        let thresholdP2PointsAbsolute = [];

        function populateThrPxTimeSelect(selectElement) {
            selectElement.innerHTML = '';
            for (const key in thrPxTimeMap) {
                const usValue = thrPxTimeMap[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${usValue} µs`;
                selectElement.appendChild(option);
            }
        }

        function calculateSpeedOfSound(temperatureC, pressurePa, heightM, relativeHumidity) {
            let T_k = temperatureC + KELVIN_OFFSET;
            let P_total = pressurePa;
            if (heightM !== 0) {
                if (heightM > 0) {
                    P_total = P0_PA * Math.pow((1 - (L * heightM) / T0_KELVIN), (G * M) / (R_UNIVERSAL * L));
                } else {
                    P_total = P0_PA * Math.pow((1 + (L * Math.abs(heightM)) / T0_KELVIN), (G * M) / (R_UNIVERSAL * L));
                }
            }

            let P_sat = SATURATION_CONSTANT * Math.pow(10, (7.5 * temperatureC) / (temperatureC + 237.3)) * 100;
            let P_v = P_sat * (relativeHumidity / RH_DIVISOR);
            let P_d = P_total - P_v;
            let H = P_v / P_d;
            let soundSpeed = Math.sqrt(GAMMA * R_D * T_k * (1 + WATER_VAPOR_EFFECT * H));
            return soundSpeed;
        }

        function snapToTvgTime(usValue) {
            let closest = tvgTimeMap[0];
            let minDiff = Math.abs(usValue - closest);

            for (const key in tvgTimeMap) {
                const mappedUs = tvgTimeMap[key];
                const diff = Math.abs(usValue - mappedUs);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = mappedUs;
                }
            }
            return closest;
        }

        function snapToThresholdTime(usValue) {
            let closest = thrPxTimeMap[0];
            let minDiff = Math.abs(usValue - closest);

            for (const key in thrPxTimeMap) {
                const mappedUs = thrPxTimeMap[key];
                const diff = Math.abs(usValue - mappedUs);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = mappedUs;
                }
            }
            return closest;
        }

        function snapToTvgGain(dBValue, afeGainBase) {
            let targetN = ((dBValue - afeGainBase) / 0.5) - 1;
            let snappedN = Math.round(Math.max(0, Math.min(63, targetN)));
            return (0.5 * (snappedN + 1)) + afeGainBase;
        }

        function getRegisterLevel(inputValue, offset, levelIndex) {
            if (levelIndex >= 1 && levelIndex <= 8) {
                return Math.max(0, Math.min(31, inputValue + offset));
            }
            return Math.max(0, Math.min(255, inputValue));
        }

        function getChartLevel(inputValue, offset, levelIndex) {
            if (levelIndex >= 1 && levelIndex <= 8) {
                return Math.max(0, Math.min(255, inputValue + offset));
            }
            return Math.max(0, Math.min(255, inputValue));
        }

        function updateAllCalculations() {
            calculateEchoParametersAndDisplay();
            updateControlValues();
            updateRegisterTable();
            updateChartPointsFromInternalData();
        }

        function calculateEchoParametersAndDisplay() {
            const transducerFreq = parseFloat(document.getElementById('transducerFreq').value);
            const numPulses = parseInt(document.getElementById('numPulses').value);
            const distanceTarget_mm = parseFloat(document.getElementById('distanceTarget').value);
            const temperatureC = parseFloat(document.getElementById('temperatureC').value);
            const pressurePa = parseFloat(document.getElementById('pressurePa').value);
            const heightM = parseFloat(document.getElementById('heightM').value);
            const relativeHumidity = parseFloat(document.getElementById('relativeHumidity').value);
            const decayTime_us = parseFloat(document.getElementById('decayTime').value);

            const distanceTarget_m = distanceTarget_mm / 1000;
            const soundSpeed = calculateSpeedOfSound(temperatureC, pressurePa, heightM, relativeHumidity);
            document.getElementById('soundSpeedDisplay').textContent = `${soundSpeed.toFixed(2)} m/s`;
            const echoReturnTime_s = (2 * distanceTarget_m) / soundSpeed;
            const echoReturnTime_us = echoReturnTime_s * 1e6;
            document.getElementById('echoReturnTimeDisplay').textContent = `${echoReturnTime_us.toFixed(2)} µs`;

            const pulseDuration_s = numPulses / transducerFreq;
            const pulseDuration_us = pulseDuration_s * 1e6;
            document.getElementById('pulseLengthDisplay').textContent = `${pulseDuration_us.toFixed(2)} µs`;

            const theoreticalRecordTime_us = echoReturnTime_us + pulseDuration_us + decayTime_us;
            document.getElementById('totalTimeDisplay').textContent = `${theoreticalRecordTime_us.toFixed(2)} µs`;

            let theoreticalPRecValue = (theoreticalRecordTime_us / 4096) - 1;
            theoreticalPRecValue = Math.round(theoreticalPRecValue);

            const displayPRecValue = Math.max(0, Math.min(255, theoreticalPRecValue));

            document.getElementById('theoreticalRecLengthDisplay').innerHTML = `
                ${displayPRecValue} (Dec)
                <span>0x${displayPRecValue.toString(16).toUpperCase().padStart(2, '0')}</span> (Hex)
                <span>0b${displayPRecValue.toString(2).padStart(8, '0')}</span> (Bin)
            `;
        }

        function updateControlValues() {
            const gainInitVal = parseInt(document.getElementById('gainInitSlider').value);
            document.getElementById('gainInitValue').textContent = gainInitVal;

            const bpfBwVal = parseInt(document.getElementById('bpfBwSlider').value);
            document.getElementById('bpfBwValue').textContent = `${2 * (bpfBwVal + 1)} kHz`;

            const currLim1Val = parseInt(document.getElementById('CURR_LIM1').value);
            document.getElementById('CURR_LIM1Value').textContent = `${7 * currLim1Val + 50} mA`;

            const lpfCoVal = parseInt(document.getElementById('lpfCoSlider').value);
            document.getElementById('lpfCoValue').textContent = `${lpfCoVal + 1} kHz`;

            const currLim2Val = parseInt(document.getElementById('CURR_LIM2').value);
            document.getElementById('CURR_LIM2Value').textContent = `${7 * currLim2Val + 50} mA`;

            const p1RecVal = parseInt(document.getElementById('p1RecSlider').value);
            document.getElementById('p1RecValue').textContent = `${p1RecVal} (${(4.096 * (p1RecVal + 1)).toFixed(3)} ms)`;

            const p2RecVal = parseInt(document.getElementById('p2RecSlider').value);
            document.getElementById('p2RecValue').textContent = `${p2RecVal} (${(4.096 * (p2RecVal + 1)).toFixed(3)} ms)`;
        }

        const afeGainRangeMap = {
            0: 58,
            1: 52,
            2: 46,
            3: 32
        };

        function convertSignedMagnitude4Bit(value) {
            if (value >= 0) {
                return value;
            } else {
                const absValue = Math.abs(value);
                if (absValue === 8) {
                    return 0b1000;
                } else {
                    return (1 << 3) | (absValue & 0x7);
                }
            }
        }

        function decodeSignedMagnitude4Bit(encodedValue) {
            const signBit = (encodedValue >> 3) & 0x1;
            const magnitude = encodedValue & 0x7;
            if (signBit === 1) {
                if (magnitude === 0) {
                    return -8;
                }
                return -magnitude;
            } else {
                return magnitude;
            }
        }
        
        /**
         * Renders a summary table for a given set of registers.
         * @param {Array<object>} registers - Array of register objects to display.
         * @param {string} containerId - The ID of the HTML element to render the table in.
         */
        function renderRegisterSummary(registers, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
        
            let tableHtml = `
                <h3>Register Summary</h3>
                <table class="registry-summary-table">
                    <thead>
                        <tr>
                            <th>Register</th>
                            <th>Address</th>
                            <th>Hex</th>
                            <th>Binary</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
        
            registers.forEach(reg => {
                const decimalValue = reg.value;
                const hexValue = decimalValue.toString(16).toUpperCase().padStart(2, '0');
                const binaryValue = decimalValue.toString(2).padStart(8, '0');
        
                tableHtml += `
                    <tr>
                        <td>${reg.name}</td>
                        <td>${reg.address}</td>
                        <td><span class="reg-hex">0x${hexValue}</span></td>
                        <td><span class="reg-bin">0b${binaryValue}</span></td>
                    </tr>
                `;
            });
        
            tableHtml += `
                    </tbody>
                </table>
            `;
            container.innerHTML = tableHtml;
        }

        /**
         * Calculates and updates the register values, populating the new summary tables.
         */
        function updateRegisterTable() {
            currentRegisterValues = {};
            
            // --- Transducer & Gain Registers ---
            const transducerRegisters = [];

            // REG_DECPL_TEMP (Address 0x26)
            const afeGainRng = parseInt(document.getElementById('gainAFE').value);
            const lpmEn = parseInt(document.getElementById('LPM_EN').value);
            const decplTempSel = parseInt(document.getElementById('DECPL_TEMP_SEL').value);
            const decplT = parseInt(document.getElementById('DECPL_T').value);
            const decplTempReg = (afeGainRng << 6) | (lpmEn << 5) | (decplTempSel << 4) | decplT;
            transducerRegisters.push({ name: 'REG_DECPL_TEMP', address: '0x26', value: decplTempReg });
            currentRegisterValues.DECPL_TEMP = decplTempReg;

            // REG_INIT_GAIN (Address 0x1B)
            const gainInit = parseInt(document.getElementById('gainInitSlider').value);
            const bpfBw = parseInt(document.getElementById('bpfBwSlider').value);
            const initGainReg = (bpfBw << 6) | gainInit;
            transducerRegisters.push({ name: 'REG_INIT_GAIN', address: '0x1B', value: initGainReg });
            currentRegisterValues.INIT_GAIN = initGainReg;

            // REG_CURR_LIM_P1 (Address 0x20)
            const disCl = parseInt(document.getElementById('DIS_CL').value);
            const currLim1 = parseInt(document.getElementById('CURR_LIM1').value);
            const currLimP1Reg = (disCl << 7) | currLim1;
            transducerRegisters.push({ name: 'REG_CURR_LIM_P1', address: '0x20', value: currLimP1Reg });
            currentRegisterValues.CURR_LIM_P1 = currLimP1Reg;
            currentRegisterValues.CURR_LIM1_BITFIELD = currLim1;

            // REG_CURR_LIM_P2 (Address 0x21)
            const lpfCo = parseInt(document.getElementById('lpfCoSlider').value);
            const currLim2 = parseInt(document.getElementById('CURR_LIM2').value);
            const currLimP2Reg = (lpfCo << 6) | currLim2;
            transducerRegisters.push({ name: 'REG_CURR_LIM_P2', address: '0x21', value: currLimP2Reg });
            currentRegisterValues.CURR_LIM_P2 = currLimP2Reg;

            // REG_REC_LENGTH (Address 0x22)
            const p1Rec = parseInt(document.getElementById('p1RecSlider').value);
            const p2Rec = parseInt(document.getElementById('p2RecSlider').value);
            const recLengthReg = (p1Rec << 4) | p2Rec;
            transducerRegisters.push({ name: 'REG_REC_LENGTH', address: '0x22', value: recLengthReg });
            currentRegisterValues.REC_LENGTH = recLengthReg;

            // TVG Registers (Addresses 0x14 - 0x1A)
            const tvgT0 = parseInt(document.getElementById('tvgT0').value);
            const tvgT1 = parseInt(document.getElementById('tvgT1').value);
            const regTvgGain0 = (tvgT0 << 4) | tvgT1;
            transducerRegisters.push({ name: 'REG_TVGAIN0', address: '0x14', value: regTvgGain0 });
            currentRegisterValues.TVGAIN0 = regTvgGain0;

            const tvgT2 = parseInt(document.getElementById('tvgT2').value);
            const tvgT3 = parseInt(document.getElementById('tvgT3').value);
            const regTvgGain1 = (tvgT2 << 4) | tvgT3;
            transducerRegisters.push({ name: 'REG_TVGAIN1', address: '0x15', value: regTvgGain1 });
            currentRegisterValues.TVGAIN1 = regTvgGain1;

            const tvgT4 = parseInt(document.getElementById('tvgT4').value);
            const tvgT5 = parseInt(document.getElementById('tvgT5').value);
            const regTvgGain2 = (tvgT4 << 4) | tvgT5;
            transducerRegisters.push({ name: 'REG_TVGAIN2', address: '0x16', value: regTvgGain2 });
            currentRegisterValues.TVGAIN2 = regTvgGain2;

            const tvgG1 = parseInt(document.getElementById('tvgG1').value);
            const tvgG2 = parseInt(document.getElementById('tvgG2').value);
            const tvgG3 = parseInt(document.getElementById('tvgG3').value);
            const tvgG4 = parseInt(document.getElementById('tvgG4').value);
            const tvgG5 = parseInt(document.getElementById('tvgG5').value);

            const regTvgGain3 = (tvgG1 << 2) | (tvgG2 & 0x3);
            transducerRegisters.push({ name: 'REG_TVGAIN3', address: '0x17', value: regTvgGain3 });
            currentRegisterValues.TVGAIN3 = regTvgGain3;

            const regTvgGain4 = ((tvgG2 >> 2) << 4) | (tvgG3 & 0xF);
            transducerRegisters.push({ name: 'REG_TVGAIN4', address: '0x18', value: regTvgGain4 });
            currentRegisterValues.TVGAIN4 = regTvgGain4;

            const regTvgGain5 = ((tvgG3 >> 4) << 6) | (tvgG4 & 0x3F);
            transducerRegisters.push({ name: 'REG_TVGAIN5', address: '0x19', value: regTvgGain5 });
            currentRegisterValues.TVGAIN5 = regTvgGain5;

            // Updated REG_TVGAIN6 calculation to include FREQ_SHIFT
            const freqShift = parseInt(document.getElementById('freq_shift').value);
            const regTvgGain6 = (tvgG5 << 2) | (0 << 1) | freqShift;
            transducerRegisters.push({ name: 'REG_TVGAIN6', address: '0x1A', value: regTvgGain6 });
            currentRegisterValues.TVGAIN6 = regTvgGain6;
            
            // Render the summary table for the Transducer & Gain section
            renderRegisterSummary(transducerRegisters, 'transducer-summary');

            // --- Threshold Preset 1 Registers ---
            const thresholdP1Registers = [];
            // ... (Calculation logic for Preset 1 registers goes here) ...
            renderRegisterSummary(thresholdP1Registers, 'thresholdP1-summary');

            // --- Threshold Preset 2 Registers ---
            const thresholdP2Registers = [];
            // ... (Calculation logic for Preset 2 registers goes here) ...
            renderRegisterSummary(thresholdP2Registers, 'thresholdP2-summary');
        }

        function calculateChecksum(dataArray) {
            let carry = 0;
            for (let i = 0; i < dataArray.length; i++) {
                carry += dataArray[i];
                if (carry > 0xFF) {
                    carry -= 255;
                }
            }
            return (~carry) & 0xFF;
        }

        function updateChartPointsFromInternalData() {
            const afeGainBase = afeGainRangeMap[parseInt(document.getElementById('gainAFE').value)];
            tvgPointsAbsolute = [];
            const initialGainValue = (0.5 * (parseInt(document.getElementById('gainInitSlider').value) + 1)) + afeGainBase;
            tvgPointsAbsolute.push({ x: 0, y: initialGainValue });
            
            const tvgT0_reg_val = parseInt(document.getElementById('tvgT0').value);
            const tvgT0_abs_us = tvgTimeMap[tvgT0_reg_val];
            tvgPointsAbsolute.push({ x: tvgT0_abs_us, y: initialGainValue });
            let currentTime = tvgT0_abs_us;

            for (let i = 1; i <= 5; i++) {
                const tvgT_delta_reg_val = parseInt(document.getElementById(`tvgT${i}`).value);
                const tvgT_delta_us = tvgTimeMap[tvgT_delta_reg_val];
                currentTime += tvgT_delta_us;

                const tvgG_val = parseFloat(document.getElementById(`tvgG${i}`).value);
                const gainAtPoint = (0.5 * (tvgG_val + 1)) + afeGainBase;
                tvgPointsAbsolute.push({ x: currentTime, y: gainAtPoint });
            }

            const totalTimeElement = document.getElementById('totalTimeDisplay');
            let totalTime_us_from_echo_params = 0;
            if (totalTimeElement && totalTimeElement.textContent) {
                totalTime_us_from_echo_params = parseFloat(totalTimeElement.textContent.replace(' µs', ''));
            }

            const p1RecVal = parseInt(document.getElementById('p1RecSlider').value);
            const p1RecUs = 4.096 * (p1RecVal + 1) * 1000;
            const p2RecVal = parseInt(document.getElementById('p2RecSlider').value);
            const p2RecUs = 4.096 * (p2RecVal + 1) * 1000;

            let calculatedMaxX = Math.max(p1RecUs, p2RecUs, totalTime_us_from_echo_params, currentTime);

            thresholdP1PointsAbsolute = [];
            let currentP1Time = 0;
            const thP1Off = parseInt(document.getElementById('thP1Off').value);
            const p1LevelsChartValues = [];
            for (let i = 1; i <= 12; i++) {
                const baseLevelInput = parseInt(document.getElementById(`thrPr1P${i}Level`).value);
                p1LevelsChartValues.push(getChartLevel(baseLevelInput, thP1Off, i));
            }
            const thP1T1_reg_val = parseInt(document.getElementById('thrPr1P1Time').value);
            const thP1T1_abs_us = thrPxTimeMap[thP1T1_reg_val];
            thresholdP1PointsAbsolute.push({ x: 0, y: p1LevelsChartValues[0] });
            thresholdP1PointsAbsolute.push({ x: thP1T1_abs_us, y: p1LevelsChartValues[0] });
            currentP1Time = thP1T1_abs_us;
            for (let i = 1; i <= 11; i++) {
                const deltaT_reg_val = parseInt(document.getElementById(`thrPr1P${i + 1}Time`).value);
                const deltaT_us = thrPxTimeMap[deltaT_reg_val];
                currentP1Time += deltaT_us;
                currentP1Time = Math.min(currentP1Time, MAX_TIME_US);
                thresholdP1PointsAbsolute.push({ x: currentP1Time, y: p1LevelsChartValues[i] });
            }
            if (p1RecUs > currentP1Time && p1RecUs <= MAX_TIME_US) {
                thresholdP1PointsAbsolute.push({ x: p1RecUs, y: p1LevelsChartValues[11] });
            } else if (currentP1Time < MAX_TIME_US) {
                 thresholdP1PointsAbsolute.push({ x: MAX_TIME_US, y: p1LevelsChartValues[11] });
            }

            thresholdP2PointsAbsolute = [];
            let currentP2Time = 0;
            const thP2Off = parseInt(document.getElementById('thP2Off').value);
            const p2LevelsChartValues = [];
            for (let i = 1; i <= 12; i++) {
                const baseLevelInput = parseInt(document.getElementById(`thrPr2P${i}Level`).value);
                p2LevelsChartValues.push(getChartLevel(baseLevelInput, thP2Off, i));
            }
            const thP2T1_reg_val = parseInt(document.getElementById('thrPr2P1Time').value);
            const thP2T1_abs_us = thrPxTimeMap[thP2T1_reg_val];
            thresholdP2PointsAbsolute.push({ x: 0, y: p2LevelsChartValues[0] });
            thresholdP2PointsAbsolute.push({ x: thP2T1_abs_us, y: p2LevelsChartValues[0] });
            currentP2Time = thP2T1_abs_us;
            for (let i = 1; i <= 11; i++) {
                const deltaT_reg_val = parseInt(document.getElementById(`thrPr2P${i + 1}Time`).value);
                const deltaT_us = thrPxTimeMap[deltaT_reg_val];
                currentP2Time += deltaT_us;
                currentP2Time = Math.min(currentP2Time, MAX_TIME_US);
                thresholdP2PointsAbsolute.push({ x: currentP2Time, y: p2LevelsChartValues[i] });
            }
            if (p2RecUs > currentP2Time && p2RecUs <= MAX_TIME_US) {
                thresholdP2PointsAbsolute.push({ x: p2RecUs, y: p2LevelsChartValues[11] });
            } else if (currentP2Time < MAX_TIME_US) {
                 thresholdP2PointsAbsolute.push({ x: MAX_TIME_US, y: p2LevelsChartValues[11] });
            }
            
            const pulseLength_us = parseFloat(document.getElementById('pulseLengthDisplay').textContent.replace(' µs', ''));
            const echoReturnTime_us = parseFloat(document.getElementById('echoReturnTimeDisplay').textContent.replace(' µs', ''));
            const decayTime_us_input = parseFloat(document.getElementById('decayTime').value);

            const annotations = {
                burstPulse: {
                    type: 'box',
                    xMin: 0,
                    xMax: pulseLength_us,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 0.5)',
                    borderWidth: 1,
                    label: { enabled: true, content: 'Burst Pulse', position: 'start', color: 'rgb(255, 99, 132)', font: { size: 10 } }
                },
                decayRegion: {
                    type: 'box',
                    xMin: pulseLength_us,
                    xMax: pulseLength_us + decayTime_us_input,
                    backgroundColor: 'rgba(255, 205, 86, 0.2)',
                    borderColor: 'rgba(255, 205, 86, 0.5)',
                    borderWidth: 1,
                    label: { enabled: true, content: 'Decay', position: 'start', color: 'rgb(255, 205, 86)', font: { size: 10 } }
                }
            };
            if (!isNaN(echoReturnTime_us) && echoReturnTime_us > 0) {
                annotations.echoRegion = {
                    type: 'box',
                    xMin: echoReturnTime_us,
                    xMax: echoReturnTime_us + pulseLength_us,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 0.5)',
                    borderWidth: 1,
                    label: { enabled: true, content: 'Echo', position: 'start', color: 'rgb(75, 192, 192)', font: { size: 10 } }
                };
            }

            if (tvgChart) {
                tvgChart.data.datasets[0].data = tvgPointsAbsolute;
                tvgChart.data.datasets[1].data = thresholdP1PointsAbsolute;
                tvgChart.data.datasets[2].data = thresholdP2PointsAbsolute;
                tvgChart.options.plugins.annotation.annotations = annotations;
                const allThresholdLevels = [...p1LevelsChartValues, ...p2LevelsChartValues];
                const maxGainLevel = Math.max(...tvgPointsAbsolute.map(p => p.y), 90);
                tvgChart.options.scales.y.max = maxGainLevel + 10;
                tvgChart.options.scales.y1.max = 255;
                tvgChart.options.scales.x.min = 0;
                tvgChart.options.scales.x.max = calculatedMaxX * 1.1;
                tvgChart.update();
            } else {
                initializeChart(tvgPointsAbsolute, thresholdP1PointsAbsolute, thresholdP2PointsAbsolute, annotations, calculatedMaxX * 1.1);
            }
        }

        function initializeChart(tvgData, thresholdP1, thresholdP2, annotations, initialXMax) {
            const ctx = document.getElementById('tvgChart').getContext('2d');
            tvgChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'TVG Gain (dB)',
                            data: tvgData,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            fill: false,
                            yAxisID: 'y',
                            pointRadius: 5,
                            pointBackgroundColor: 'rgb(75, 192, 192)',
                            showLine: true,
                            dragData: true,
                            dragX: true,
                            dragY: true,
                        },
                        {
                            label: 'Threshold P1 (ADC Level)',
                            data: thresholdP1,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            showLine: true,
                            pointRadius: 5,
                            pointBackgroundColor: 'rgb(255, 99, 132)',
                            type: 'scatter',
                            yAxisID: 'y1',
                            dragData: true,
                            dragX: true,
                            dragY: true,
                        },
                        {
                            label: 'Threshold P2 (ADC Level)',
                            data: thresholdP2,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            showLine: true,
                            pointRadius: 5,
                            pointBackgroundColor: 'rgb(54, 162, 235)',
                            type: 'scatter',
                            yAxisID: 'y1',
                            dragData: true,
                            dragX: true,
                            dragY: true,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Time (µs)'
                            },
                            min: 0,
                            max: initialXMax,
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Gain (dB)'
                            },
                            min: 0,
                            max: 100
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'ADC Level'
                            },
                            min: 0,
                            max: 255,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'xy',
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy',
                                limits: {
                                    x: { min: 0 }
                                }
                            }
                        },
                        annotation: {
                            annotations: annotations
                        },
                        dragData: {
                            onDragStart: function(e, datasetIndex, index) {
                                e.target.style.cursor = 'grabbing';
                            },
                            onDrag: function(e, datasetIndex, index, value) {},
                            onDragEnd: function(e, datasetIndex, index, value) {
                                e.target.style.cursor = 'grab';
                                let newX = Math.max(0, value.x);
                                let newY = value.y;
                                if (newX > MAX_TIME_US) { newX = MAX_TIME_US; }

                                if (datasetIndex === 0) {
                                    const afeGainBase = afeGainRangeMap[parseInt(document.getElementById('gainAFE').value)];
                                    newY = snapToTvgGain(newY, afeGainBase);
                                    if (index === 0) {
                                        newX = 0;
                                        tvgPointsAbsolute[0].y = newY;
                                        tvgPointsAbsolute[1].y = newY;
                                    } else if (index === 1) {
                                        newX = snapToTvgTime(newX);
                                        tvgPointsAbsolute[1].x = newX;
                                        tvgPointsAbsolute[1].y = newY;
                                    } else {
                                        newX = snapToTvgTime(newX);
                                        const prevX = tvgPointsAbsolute[index - 1].x;
                                        if (newX < prevX) { newX = prevX; }
                                        tvgPointsAbsolute[index].x = newX;
                                        tvgPointsAbsolute[index].y = newY;
                                    }
                                    updateTvgInputsFromAbsoluteData();
                                } else if (datasetIndex === 1 || datasetIndex === 2) {
                                    const absolutePoints = datasetIndex === 1 ? thresholdP1PointsAbsolute : thresholdP2PointsAbsolute;
                                    newX = snapToThresholdTime(newX);
                                    newY = Math.max(0, Math.min(255, newY));
                                    const prevX = absolutePoints[index - 1] ? absolutePoints[index - 1].x : 0;
                                    if (newX < prevX) { newX = prevX; }
                                    absolutePoints[index].x = newX;
                                    absolutePoints[index].y = newY;
                                    updateThresholdInputsFromAbsoluteData(datasetIndex === 1 ? 1 : 2);
                                }
                                updateAllCalculations();
                            }
                        }
                    }
                }
            });
        }

        function updateTvgInputsFromAbsoluteData() {
            const afeGainBase = afeGainRangeMap[parseInt(document.getElementById('gainAFE').value)];
            const initialGainChart = tvgPointsAbsolute[0].y;
            let gainInitVal = Math.round(((initialGainChart - afeGainBase) / 0.5) - 1);
            gainInitVal = Math.max(0, Math.min(63, gainInitVal));
            document.getElementById('gainInitSlider').value = gainInitVal;

            const tvgT0_abs_us = tvgPointsAbsolute[1].x;
            const tvgT0_reg_val = tvgTimeInverseMap[snapToTvgTime(tvgT0_abs_us)];
            document.getElementById('tvgT0').value = tvgT0_reg_val;

            for (let i = 1; i <= 5; i++) {
                const currentPoint = tvgPointsAbsolute[i + 1];
                const prevPoint = tvgPointsAbsolute[i];
                let deltaT = currentPoint.x - prevPoint.x;
                deltaT = snapToTvgTime(deltaT);
                const tvgT_reg_val = tvgTimeInverseMap[deltaT];
                document.getElementById(`tvgT${i}`).value = tvgT_reg_val;

                let gainAtPoint = currentPoint.y;
                let tvgG_val = Math.round(((gainAtPoint - afeGainBase) / 0.5) - 1);
                tvgG_val = Math.max(0, Math.min(63, tvgG_val));
                document.getElementById(`tvgG${i}`).value = tvgG_val;
            }
        }

        function updateThresholdInputsFromAbsoluteData(presetNum) {
            const absolutePoints = presetNum === 1 ? thresholdP1PointsAbsolute : thresholdP2PointsAbsolute;
            const thOffInput = document.getElementById(`thP${presetNum}Off`);
            const thOffset = parseInt(thOffInput.value);

            const thrP1LevelInput = document.getElementById(`thrPr${presetNum}P1Level`);
            let newL1ChartValue = absolutePoints[1].y;
            let newL1InputValue;
            newL1InputValue = newL1ChartValue - thOffset;
            newL1InputValue = Math.max(0, Math.min(248, newL1InputValue));
            thrP1LevelInput.value = newL1InputValue;

            for (let i = 1; i <= 11; i++) {
                const currentPoint = absolutePoints[i + 1];
                const prevPoint = absolutePoints[i];
                let deltaT_us = currentPoint.x - prevPoint.x;
                deltaT_us = snapToThresholdTime(deltaT_us);
                deltaT_us = Math.max(MIN_THRESHOLD_TIME_US, deltaT_us);

                const deltaT_reg_val = thrPxTimeInverseMap[deltaT_us];
                document.getElementById(`thrPr${presetNum}P${i + 1}Time`).value = deltaT_reg_val;

                let newLevelChartValue = currentPoint.y;
                let newLevelInputValue;
                if ((i + 1) >= 1 && (i + 1) <= 8) {
                    newLevelInputValue = newLevelChartValue - thOffset;
                    newLevelInputValue = Math.max(0, Math.min(248, newLevelInputValue));
                } else {
                    newLevelInputValue = newLevelChartValue;
                    newLevelInputValue = Math.max(0, Math.min(255, newLevelInputValue));
                }
                document.getElementById(`thrPr${presetNum}P${i + 1}Level`).value = newLevelInputValue;
            }
        }

        function parseHFileContent(hFileContent) {
            const parsedValues = {};
            const getHexValue = (match) => parseInt(match[1], 16);
            let match;
            match = hFileContent.match(/\.DECPL_TEMP\.Val\s*=\s*(0x[0-9A-Fa-f]{2})/);
            if (match) {
                const decplTempReg = getHexValue(match);
                parsedValues.gainAFE = (decplTempReg >> 6) & 0x3;
                parsedValues.LPM_EN = (decplTempReg >> 5) & 0x1;
                parsedValues.DECPL_TEMP_SEL = (decplTempReg >> 4) & 0x1;
                parsedValues.DECPL_T = decplTempReg & 0xF;
            }
            match = hFileContent.match(/\.INIT_GAIN\.Val\s*=\s*(0x[0-9A-Fa-f]{2})/);
            if (match) {
                const initGainReg = getHexValue(match);
                parsedValues.bpfBwSlider = (initGainReg >> 6) & 0x3;
                parsedValues.gainInitSlider = initGainReg & 0x3F;
            }
            match = hFileContent.match(/\.CURR_LIM_P1\.Val\.BitField\.CURR_LIM1\s*=\s*(0x[0-9A-Fa-f]{2})/);
            if (match) {
                const currLim1Val = getHexValue(match);
                parsedValues.CURR_LIM1 = currLim1Val;
                const fullCurrLimP1Match = hFileContent.match(/\.CURR_LIM_P1\.Val\s*=\s*(0x[0-9A-Fa-f]{2})/);
                if (fullCurrLimP1Match) {
                    const fullCurrLimP1Reg = getHexValue(fullCurrLimP1Match);
                    parsedValues.DIS_CL = (fullCurrLimP1Reg >> 7) & 0x1;
                } else {
                    parsedValues.DIS_CL = 0;
                }
            }
            match = hFileContent.match(/\.CURR_LIM_P2\.Val\s*=\s*(0x[0-9A-Fa-f]{2})/);
            if (match) {
                const currLimP2Reg = getHexValue(match);
                parsedValues.lpfCoSlider = (currLimP2Reg >> 6) & 0x3;
                parsedValues.CURR_LIM2 = currLimP2Reg & 0x3F;
            }
            match = hFileContent.match(/\.REC_LENGTH\.Val\s*=\s*(0x[0-9A-Fa-f]{2})/);
            if (match) {
                const recLengthReg = getHexValue(match);
                parsedValues.p1RecSlider = (recLengthReg >> 4) & 0xF;
                parsedValues.p2RecSlider = recLengthReg & 0xF;
            }
            match = hFileContent.match(/\.DSP_SCALE\.Val\s*=\s*(0x[0-9A-Fa-f]{2})/);
            if (match) {
                const dspScaleReg = getHexValue(match);
                parsedValues.noiseLevelInput = (dspScaleReg >> 3) & 0x1F;
            }
            match = hFileContent.match(/\.P1_GAIN_CTRL\.Val\s*=\s*(0x[0-9A-Fa-f]{2})/);
            if (match) {
                const p1GainCtrlReg = getHexValue(match);
                parsedValues.p1DigGainLrSt = (p1GainCtrlReg >> 6) & 0x3;
                parsedValues.p1DigGainLr = (p1GainCtrlReg >> 3) & 0x7;
                parsedValues.p1DigGainSr = p1GainCtrlReg & 0x7;
            }
            match = hFileContent.match(/\.P2_GAIN_CTRL\.Val\s*=\s*(0x[0-9A-Fa-f]{2})/);
            if (match) {
                const p2GainCtrlReg = getHexValue(match);
                parsedValues.p2DigGainLrSt = (p2GainCtrlReg >> 6) & 0x3;
                parsedValues.p2DigGainLr = (p2GainCtrlReg >> 3) & 0x7;
                parsedValues.p2DigGainSr = p2GainCtrlReg & 0x7;
            }

            for (let i = 0; i <= 5; i++) {
                match = hFileContent.match(new RegExp(`\\.TVGAIN${i}\\.Val\\.Value\\s*=\\s*(0x[0-9A-Fa-f]{2})`));
                if (match) {
                    const tvgReg = getHexValue(match);
                    if (i === 0) {
                        parsedValues.tvgT0 = tvgTimeInverseMap[(tvgReg >> 4) & 0xF];
                        parsedValues.tvgT1 = tvgTimeInverseMap[tvgReg & 0xF];
                    } else if (i >= 1 && i <= 2) {
                        parsedValues[`tvgT${2*i}`] = tvgTimeInverseMap[(tvgReg >> 4) & 0xF];
                        parsedValues[`tvgT${2*i+1}`] = tvgTimeInverseMap[tvgReg & 0xF];
                    } else if (i === 3) {
                        const tvg3 = getHexValue(match);
                        const tvgG1Val = (tvg3 >> 2) & 0x3F;
                        const tvgG2Lower = tvg3 & 0x3;
                        parsedValues.tvgG1 = tvgG1Val;
                        match = hFileContent.match(/\.TVGAIN4\.Val\.Value\s*=\s*(0x[0-9A-Fa-f]{2})/);
                        if (match) {
                            const tvg4 = getHexValue(match);
                            const tvgG2Upper = (tvg4 >> 4) & 0xF;
                            parsedValues.tvgG2 = (tvgG2Upper << 2) | tvgG2Lower;
                            parsedValues.tvgG3 = tvg4 & 0xF;
                        }
                    } else if (i === 5) {
                        const tvg5 = getHexValue(match);
                        const tvgG3Upper = (tvg5 >> 6) & 0x3;
                        parsedValues.tvgG3 = (tvgG3Upper << 4) | parsedValues.tvgG3;
                        parsedValues.tvgG4 = tvg5 & 0x3F;
                    }
                }
            }
            match = hFileContent.match(/\.TVGAIN6\.Val\.Value\s*=\s*(0x[0-9A-Fa-f]{2})/);
            if (match) {
                const tvg6 = getHexValue(match);
                parsedValues.tvgG5 = (tvg6 >> 2) & 0x3F;
                parsedValues.freq_shift = tvg6 & 0x1;
            }

            match = hFileContent.match(/\.P1_THR_15\.Val\.Value\s*=\s*(0x[0-9A-Fa-f]{2})/);
            if (match) { parsedValues.thP1Off = decodeSignedMagnitude4Bit(getHexValue(match)); }
            match = hFileContent.match(/\.P2_THR_15\.Val\.Value\s*=\s*(0x[0-9A-Fa-f]{2})/);
            if (match) { parsedValues.thP2Off = decodeSignedMagnitude4Bit(getHexValue(match)); }

            const p1TimesRegs = [];
            for (let i = 0; i <= 5; i++) {
                match = hFileContent.match(new RegExp(`\\.P1_THR_${i}\\.Val\\.Value\\s*=\\s*(0x[0-9A-Fa-f]{2})`));
                if (match) p1TimesRegs.push(getHexValue(match));
            }
            if (p1TimesRegs.length === 6) {
                parsedValues.thrPr1P1Time = (p1TimesRegs[0] >> 4) & 0xF;
                parsedValues.thrPr1P2Time = p1TimesRegs[0] & 0xF;
                parsedValues.thrPr1P3Time = (p1TimesRegs[1] >> 4) & 0xF;
                parsedValues.thrPr1P4Time = p1TimesRegs[1] & 0xF;
                parsedValues.thrPr1P5Time = (p1TimesRegs[2] >> 4) & 0xF;
                parsedValues.thrPr1P6Time = p1TimesRegs[2] & 0xF;
                parsedValues.thrPr1P7Time = (p1TimesRegs[3] >> 4) & 0xF;
                parsedValues.thrPr1P8Time = p1TimesRegs[3] & 0xF;
                parsedValues.thrPr1P9Time = (p1TimesRegs[4] >> 4) & 0xF;
                parsedValues.thrPr1P10Time = p1TimesRegs[4] & 0xF;
                parsedValues.thrPr1P11Time = (p1TimesRegs[5] >> 4) & 0xF;
                parsedValues.thrPr1P12Time = p1TimesRegs[5] & 0xF;
            }

            const p1LevelRegs = [];
            for (let i = 6; i <= 14; i++) {
                match = hFileContent.match(new RegExp(`\\.P1_THR_${i}(?:\\.Val\\.Value)?\\s*=\\s*(0x[0-9A-Fa-f]{2})`));
                if (match) p1LevelRegs.push(getHexValue(match));
            }
            if (p1LevelRegs.length >= 9) {
                const l1Reg = (p1LevelRegs[0] >> 3) & 0x1F;
                const l2Reg_upper = p1LevelRegs[0] & 0x7;
                const l2Reg_lower = (p1LevelRegs[1] >> 6) & 0x3;
                const l3Reg = (p1LevelRegs[1] >> 1) & 0x1F;
                const l4Reg_upper = p1LevelRegs[1] & 0x1;
                const l4Reg_lower = (p1LevelRegs[2] >> 4) & 0xF;
                const l5Reg_upper = p1LevelRegs[2] & 0xF;
                const l5Reg_lower = (p1LevelRegs[3] >> 7) & 0x1;
                const l6Reg = (p1LevelRegs[3] >> 2) & 0x1F;
                const l7Reg_upper = p1LevelRegs[3] & 0x3;
                const l7Reg_lower = (p1LevelRegs[4] >> 5) & 0x7;
                const l8Reg = p1LevelRegs[4] & 0x1F;
                const l9Reg = p1LevelRegs[5];
                const l10Reg = p1LevelRegs[6];
                const l11Reg = p1LevelRegs[7];
                const l12Reg = p1LevelRegs[8];

                parsedValues.thrPr1P1Level = Math.max(0, Math.min(248, l1Reg - parsedValues.thP1Off));
                parsedValues.thrPr1P2Level = Math.max(0, Math.min(248, ((l2Reg_upper << 2) | l2Reg_lower) - parsedValues.thP1Off));
                parsedValues.thrPr1P3Level = Math.max(0, Math.min(248, l3Reg - parsedValues.thP1Off));
                parsedValues.thrPr1P4Level = Math.max(0, Math.min(248, ((l4Reg_upper << 4) | l4Reg_lower) - parsedValues.thP1Off));
                parsedValues.thrPr1P5Level = Math.max(0, Math.min(248, ((l5Reg_upper << 1) | l5Reg_lower) - parsedValues.thP1Off));
                parsedValues.thrPr1P6Level = Math.max(0, Math.min(248, l6Reg - parsedValues.thP1Off));
                parsedValues.thrPr1P7Level = Math.max(0, Math.min(248, ((l7Reg_upper << 3) | l7Reg_lower) - parsedValues.thP1Off));
                parsedValues.thrPr1P8Level = Math.max(0, Math.min(248, l8Reg - parsedValues.thP1Off));
                parsedValues.thrPr1P9Level = l9Reg;
                parsedValues.thrPr1P10Level = l10Reg;
                parsedValues.thrPr1P11Level = l11Reg;
                parsedValues.thrPr1P12Level = l12Reg;
            }

            const p2TimesRegs = [];
            for (let i = 0; i <= 5; i++) {
                match = hFileContent.match(new RegExp(`\\.P2_THR_${i}\\.Val\\.Value\\s*=\\s*(0x[0-9A-Fa-f]{2})`));
                if (match) p2TimesRegs.push(getHexValue(match));
            }
            if (p2TimesRegs.length === 6) {
                parsedValues.thrPr2P1Time = (p2TimesRegs[0] >> 4) & 0xF;
                parsedValues.thrPr2P2Time = p2TimesRegs[0] & 0xF;
                parsedValues.thrPr2P3Time = (p2TimesRegs[1] >> 4) & 0xF;
                parsedValues.thrPr2P4Time = p2TimesRegs[1] & 0xF;
                parsedValues.thrPr2P5Time = (p2TimesRegs[2] >> 4) & 0xF;
                parsedValues.thrPr2P6Time = p2TimesRegs[2] & 0xF;
                parsedValues.thrPr2P7Time = (p2TimesRegs[3] >> 4) & 0xF;
                parsedValues.thrPr2P8Time = p2TimesRegs[3] & 0xF;
                parsedValues.thrPr2P9Time = (p2TimesRegs[4] >> 4) & 0xF;
                parsedValues.thrPr2P10Time = p2TimesRegs[4] & 0xF;
                parsedValues.thrPr2P11Time = (p2TimesRegs[5] >> 4) & 0xF;
                parsedValues.thrPr2P12Time = p2TimesRegs[5] & 0xF;
            }

            const p2LevelRegs = [];
            for (let i = 6; i <= 14; i++) {
                match = hFileContent.match(new RegExp(`\\.P2_THR_${i}(?:\\.Val\\.Value)?\\s*=\\s*(0x[0-9A-Fa-f]{2})`));
                if (match) p2LevelRegs.push(getHexValue(match));
            }
            if (p2LevelRegs.length >= 9) {
                const l1Reg = (p2LevelRegs[0] >> 3) & 0x1F;
                const l2Reg_upper = p2LevelRegs[0] & 0x7;
                const l2Reg_lower = (p2LevelRegs[1] >> 6) & 0x3;
                const l3Reg = (p2LevelRegs[1] >> 1) & 0x1F;
                const l4Reg_upper = p2LevelRegs[1] & 0x1;
                const l4Reg_lower = (p2LevelRegs[2] >> 4) & 0xF;
                const l5Reg_upper = p2LevelRegs[2] & 0xF;
                const l5Reg_lower = (p2LevelRegs[3] >> 7) & 0x1;
                const l6Reg = (p2LevelRegs[3] >> 2) & 0x1F;
                const l7Reg_upper = p2LevelRegs[3] & 0x3;
                const l7Reg_lower = (p2LevelRegs[4] >> 5) & 0x7;
                const l8Reg = p2LevelRegs[4] & 0x1F;
                const l9Reg = p2LevelRegs[5];
                const l10Reg = p2LevelRegs[6];
                const l11Reg = p2LevelRegs[7];
                const l12Reg = p2LevelRegs[8];

                parsedValues.thrPr2P1Level = Math.max(0, Math.min(248, l1Reg - parsedValues.thP2Off));
                parsedValues.thrPr2P2Level = Math.max(0, Math.min(248, ((l2Reg_upper << 2) | l2Reg_lower) - parsedValues.thP2Off));
                parsedValues.thrPr2P3Level = Math.max(0, Math.min(248, l3Reg - parsedValues.thP2Off));
                parsedValues.thrPr2P4Level = Math.max(0, Math.min(248, ((l4Reg_upper << 4) | l4Reg_lower) - parsedValues.thP2Off));
                parsedValues.thrPr2P5Level = Math.max(0, Math.min(248, ((l5Reg_upper << 1) | l5Reg_lower) - parsedValues.thP2Off));
                parsedValues.thrPr2P6Level = Math.max(0, Math.min(248, l6Reg - parsedValues.thP2Off));
                parsedValues.thrPr2P7Level = Math.max(0, Math.min(248, ((l7Reg_upper << 3) | l7Reg_lower) - parsedValues.thP2Off));
                parsedValues.thrPr2P8Level = Math.max(0, Math.min(248, l8Reg - parsedValues.thP2Off));
                parsedValues.thrPr2P9Level = l9Reg;
                parsedValues.thrPr2P10Level = l10Reg;
                parsedValues.thrPr2P11Level = l11Reg;
                parsedValues.thrPr2P12Level = l12Reg;
            }

            return parsedValues;
        }

        document.addEventListener('DOMContentLoaded', () => {
            for (let i = 1; i <= 12; i++) {
                populateThrPxTimeSelect(document.getElementById(`thrPr1P${i}Time`));
                populateThrPxTimeSelect(document.getElementById(`thrPr2P${i}Time`));
            }

            const inputs = document.querySelectorAll(
                'input[type="number"], input[type="range"], select'
            );

            inputs.forEach(input => {
                input.addEventListener('input', (event) => {
                    updateAllCalculations();
                });
            });

            document.querySelectorAll('.container-header').forEach(header => {
                header.addEventListener('click', () => {
                    const targetId = header.dataset.target;
                    const content = document.getElementById(targetId);
                    const button = header.querySelector('.toggle-button');
                    if (content && button) {
                        content.classList.toggle('expanded');
                        button.classList.toggle('expanded');
                    }
                });
            });

            updateAllCalculations();
        });

        document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            let hFileContent = `// This file was automatically generated by the PGA460 Configuration Tool.
#ifndef PGA460_CONFIG_H
#define PGA460_CONFIG_H

#include <stdint.h>

const uint8_t PGA460_TRANSDUCER_SETTINGS[] = {
    // EEPROM Address 0x14-0x2B
    0x${currentRegisterValues.TVGAIN0.toString(16).toUpperCase().padStart(2, '0')}, // 0x14
    0x${currentRegisterValues.TVGAIN1.toString(16).toUpperCase().padStart(2, '0')}, // 0x15
    0x${currentRegisterValues.TVGAIN2.toString(16).toUpperCase().padStart(2, '0')}, // 0x16
    0x${currentRegisterValues.TVGAIN3.toString(16).toUpperCase().padStart(2, '0')}, // 0x17
    0x${currentRegisterValues.TVGAIN4.toString(16).toUpperCase().padStart(2, '0')}, // 0x18
    0x${currentRegisterValues.TVGAIN5.toString(16).toUpperCase().padStart(2, '0')}, // 0x19
    0x${currentRegisterValues.TVGAIN6.toString(16).toUpperCase().padStart(2, '0')}, // 0x1A
    0x${currentRegisterValues.INIT_GAIN.toString(16).toUpperCase().padStart(2, '0')}, // 0x1B
    0x${currentRegisterValues.FREQ.toString(16).toUpperCase().padStart(2, '0')}, // 0x1C
    0x${currentRegisterValues.DEADTIME.toString(16).toUpperCase().padStart(2, '0')}, // 0x1D
    0x${currentRegisterValues.PULSE_P1.toString(16).toUpperCase().padStart(2, '0')}, // 0x1E
    0x${currentRegisterValues.PULSE_P2.toString(16).toUpperCase().padStart(2, '0')}, // 0x1F
    0x${currentRegisterValues.CURR_LIM_P1.toString(16).toUpperCase().padStart(2, '0')}, // 0x20
    0x${currentRegisterValues.CURR_LIM_P2.toString(16).toUpperCase().padStart(2, '0')}, // 0x21
    0x${currentRegisterValues.REC_LENGTH.toString(16).toUpperCase().padStart(2, '0')}, // 0x22
    0x${currentRegisterValues.FREQ_DIAG.toString(16).toUpperCase().padStart(2, '0')}, // 0x23
    0x${currentRegisterValues.SAT_FDIAG_TH.toString(16).toUpperCase().padStart(2, '0')}, // 0x24
    0x${currentRegisterValues.FVOLT_DEC.toString(16).toUpperCase().padStart(2, '0')}, // 0x25
    0x${currentRegisterValues.DECPL_TEMP.toString(16).toUpperCase().padStart(2, '0')}, // 0x26
    0x${currentRegisterValues.DSP_SCALE.toString(16).toUpperCase().padStart(2, '0')}, // 0x27
    0x${currentRegisterValues.TEMP_TRIM.toString(16).toUpperCase().padStart(2, '0')}, // 0x28
    0x${currentRegisterValues.P1_GAIN_CTRL.toString(16).toUpperCase().padStart(2, '0')}, // 0x29
    0x${currentRegisterValues.P2_GAIN_CTRL.toString(16).toUpperCase().padStart(2, '0')}, // 0x2A
    0x${currentRegisterValues.EE_CRC.toString(16).toUpperCase().padStart(2, '0')}  // 0x2B
};

const uint8_t PGA460_THRESHOLD_P1[] = {
    0x${currentRegisterValues.P1_THR_0.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_1.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_2.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_3.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_4.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_5.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_6.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_7.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_8.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_9.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_10.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_11.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_12.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_13.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_14.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P1_THR_15.toString(16).toUpperCase().padStart(2, '0')}
};

const uint8_t PGA460_THRESHOLD_P2[] = {
    0x${currentRegisterValues.P2_THR_0.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_1.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_2.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_3.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_4.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_5.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_6.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_7.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_8.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_9.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_10.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_11.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_12.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_13.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_14.toString(16).toUpperCase().padStart(2, '0')},
    0x${currentRegisterValues.P2_THR_15.toString(16).toUpperCase().padStart(2, '0')}
};

const uint8_t PGA460_THR_CRC = 0x${currentRegisterValues.THR_CRC.toString(16).toUpperCase().padStart(2, '0')};

#endif // PGA460_CONFIG_H`;

            const blob = new Blob([hFileContent], { type: 'text/x-csrc' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pga460_config.h';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log("PGA460 configuration saved to pga460_config.h");
        });

        document.getElementById('loadSettingsBtn').addEventListener('click', () => {
            document.getElementById('loadFileInput').click();
        });

        document.getElementById('loadFileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const hFileContent = e.target.result;
                        const parsedSettings = parseHFileContent(hFileContent);

                        for (const id in parsedSettings) {
                            const input = document.getElementById(id);
                            if (input) {
                                input.value = parsedSettings[id];
                                input.dispatchEvent(new Event('input', { bubbles: true }));
                            } else {
                                console.warn(`UI element with ID '${id}' not found for loading.`);
                            }
                        }
                        updateAllCalculations();
                        console.log("Settings loaded successfully from .h file.");
                    } catch (error) {
                        console.error('Failed to load settings: Error parsing .h file.', error);
                        console.error('Failed to load settings: Please ensure it is a valid .h file generated by this tool.');
                    }
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('resetZoomBtn').addEventListener('click', () => {
            if (tvgChart) {
                tvgChart.resetZoom();
            }
        });

        document.getElementById('setMinValuesBtn').addEventListener('click', () => {
            for (let i = 1; i <= 12; i++) {
                const p1TimeSelect = document.getElementById(`thrPr1P${i}Time`);
                if (p1TimeSelect) {
                    p1TimeSelect.value = 0;
                    p1TimeSelect.dispatchEvent(new Event('input', { bubbles: true }));
                }
                const p2TimeSelect = document.getElementById(`thrPr2P${i}Time`);
                if (p2TimeSelect) {
                    p2TimeSelect.value = 0;
                    p2TimeSelect.dispatchEvent(new Event('input', { bubbles: true }));
                }

                const p1LevelInput = document.getElementById(`thrPr1P${i}Level`);
                if (p1LevelInput) {
                    p1LevelInput.value = p1LevelInput.min;
                    p1LevelInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                const p2LevelInput = document.getElementById(`thrPr2P${i}Level`);
                if (p2LevelInput) {
                    p2LevelInput.value = p2LevelInput.min;
                    p2LevelInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
            const inputs = document.querySelectorAll(
                'input[type="number"]:not([id^="thrPr1P"][id$="Time"]):not([id^="thrPr2P"][id$="Time"]):not([id^="thrPr1P"][id$="Level"]):not([id^="thrPr2P"][id$="Level"]), input[type="range"]'
            );
            inputs.forEach(input => {
                const minValue = parseFloat(input.min);
                if (!isNaN(minValue)) {
                    input.value = minValue;
                } else {
                    if (input.type === 'number') { input.value = 0; } 
                    else if (input.type === 'range') { input.value = 0; }
                }
                input.dispatchEvent(new Event('input', { bubbles: true }));
            });
            document.getElementById('thP1Off').value = document.getElementById('thP1Off').min;
            document.getElementById('thP1Off').dispatchEvent(new Event('input', { bubbles: true }));
            document.getElementById('thP2Off').value = document.getElementById('thP2Off').min;
            document.getElementById('thP2Off').dispatchEvent(new Event('input', { bubbles: true }));

            const selects = document.querySelectorAll('select:not([id^="thrPr1P"][id$="Time"]):not([id^="thrPr2P"][id$="Time"])');
            selects.forEach(select => {
                if (select.options.length > 0) {
                    select.value = select.options[0].value;
                }
                select.dispatchEvent(new Event('input', { bubbles: true }));
            });

            updateAllCalculations();
            console.log("All input values set to their minimums.");
        });
    </script>
</body>
</html>